<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Dashboard - Gym Management System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Gym Management System</div>
        <div class="nav-links">
            <a href="{{ url_for('trainer_dashboard') }}" class="active">Dashboard</a>
            <a href="{{ url_for('profile') }}">Profile</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <h1>Welcome, {{ user.name }}</h1>
        
        <div class="dashboard-grid">
            <!-- Classes Overview -->
            <div class="dashboard-card">
                <h2>Your Classes</h2>
                <div id="classes-list" class="scrollable-list">
                    <!-- Classes will be loaded here -->
                </div>
                <button onclick="showCreateClassModal()" class="btn-primary">Create New Class</button>
            </div>

            <!-- Schedule -->
            <div class="dashboard-card">
                <h2>Schedule</h2>
                <div id="schedule-calendar" class="calendar-view">
                    <!-- Calendar will be loaded here -->
                </div>
            </div>

            <!-- Class Roster -->
            <div class="dashboard-card">
                <h2>Class Roster</h2>
                <select id="class-selector" onchange="loadRoster()">
                    <option value="">Select a class</option>
                </select>
                <div id="roster-list" class="scrollable-list">
                    <!-- Roster will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div id="create-class-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('create-class-modal')">&times;</span>
            <h2>Create New Class</h2>
            <form id="create-class-form" onsubmit="createClass(event)">
                <div class="form-group">
                    <label for="class-name">Class Name:</label>
                    <input type="text" id="class-name" name="class_name" required>
                </div>
                <div class="form-group">
                    <label for="schedule-time">Schedule Time:</label>
                    <input type="datetime-local" id="schedule-time" name="schedule_time" required>
                </div>
                <div class="form-group">
                    <label for="capacity">Capacity:</label>
                    <input type="number" id="capacity" name="capacity" min="1" max="50" required>
                </div>
                <button type="submit" class="btn-primary">Create Class</button>
            </form>
        </div>
    </div>

    <!-- Edit Class Modal -->
    <div id="edit-class-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('edit-class-modal')">&times;</span>
            <h2>Edit Class</h2>
            <form id="edit-class-form" onsubmit="updateClass(event)">
                <input type="hidden" id="edit-class-id">
                <div class="form-group">
                    <label for="edit-class-name">Class Name:</label>
                    <input type="text" id="edit-class-name" name="class_name" required>
                </div>
                <div class="form-group">
                    <label for="edit-schedule-time">Schedule Time:</label>
                    <input type="datetime-local" id="edit-schedule-time" name="schedule_time" required>
                </div>
                <div class="form-group">
                    <label for="edit-capacity">Capacity:</label>
                    <input type="number" id="edit-capacity" name="capacity" min="1" max="50" required>
                </div>
                <button type="submit" class="btn-primary">Update Class</button>
            </form>
        </div>
    </div>

    <script>
        // Load trainer's classes
        async function loadClasses() {
            try {
                const response = await fetch('/api/trainer/classes', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const classes = await response.json();
                
                const classList = document.getElementById('classes-list');
                classList.innerHTML = '';
                
                classes.forEach(cls => {
                    const classDiv = document.createElement('div');
                    classDiv.className = 'class-item';
                    classDiv.innerHTML = `
                        <h3>${cls.class_name}</h3>
                        <p>Time: ${new Date(cls.schedule_time).toLocaleString()}</p>
                        <p>Capacity: ${cls.current_bookings}/${cls.capacity}</p>
                        <div class="class-actions">
                            <button onclick="showEditClassModal(${cls.id})" class="btn-secondary">Edit</button>
                            <button onclick="deleteClass(${cls.id})" class="btn-danger">Delete</button>
                            <button onclick="viewRoster(${cls.id})" class="btn-info">View Roster</button>
                        </div>
                    `;
                    classList.appendChild(classDiv);
                });
                
                // Update class selector
                const selector = document.getElementById('class-selector');
                selector.innerHTML = '<option value="">Select a class</option>';
                classes.forEach(cls => {
                    selector.innerHTML += `<option value="${cls.id}">${cls.class_name} - ${new Date(cls.schedule_time).toLocaleString()}</option>`;
                });
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        // Load schedule
        async function loadSchedule() {
            try {
                const response = await fetch('/api/schedule', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const schedule = await response.json();
                
                const scheduleList = document.getElementById('schedule-list');
                scheduleList.innerHTML = '';
                
                Object.entries(schedule).forEach(([date, classes]) => {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'schedule-date';
                    dateDiv.innerHTML = `<h3>${new Date(date).toLocaleDateString()}</h3>`;
                    
                    classes.forEach(cls => {
                        const classDiv = document.createElement('div');
                        classDiv.className = 'schedule-class';
                        classDiv.innerHTML = `
                            <h4>${cls.class_name}</h4>
                            <p>Time: ${new Date(cls.schedule_time).toLocaleTimeString()}</p>
                            <p>Bookings: ${cls.current_bookings}/${cls.capacity}</p>
                        `;
                        dateDiv.appendChild(classDiv);
                    });
                    
                    scheduleList.appendChild(dateDiv);
                });
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        // Load roster for selected class
        async function loadRoster() {
            const classId = document.getElementById('class-selector').value;
            if (!classId) {
                document.getElementById('roster-list').innerHTML = '<p>Please select a class</p>';
                return;
            }
            
            try {
                const response = await fetch(`/api/trainer/classes/${classId}/roster`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const roster = await response.json();
                
                const rosterList = document.getElementById('roster-list');
                rosterList.innerHTML = '';
                
                roster.forEach(student => {
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'roster-item';
                    studentDiv.innerHTML = `
                        <h4>${student.name}</h4>
                        <p>Email: ${student.email}</p>
                        <p>Booked: ${new Date(student.booking_date).toLocaleString()}</p>
                        <p>Past Attendance: ${student.past_attendance} classes</p>
                    `;
                    rosterList.appendChild(studentDiv);
                });
            } catch (error) {
                console.error('Error loading roster:', error);
            }
        }

        // Create new class
        async function createClass(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                class_name: formData.get('class_name'),
                schedule_time: formData.get('schedule_time'),
                capacity: parseInt(formData.get('capacity'))
            };
            
            try {
                const response = await fetch('/api/trainer/classes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('create-class-modal');
                    loadClasses();
                    loadSchedule();
                } else {
                    const error = await response.json();
                    alert(error.error);
                }
            } catch (error) {
                console.error('Error creating class:', error);
            }
        }

        // Update existing class
        async function updateClass(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const classId = formData.get('class_id');
            const data = {
                class_name: formData.get('class_name'),
                schedule_time: formData.get('schedule_time'),
                capacity: parseInt(formData.get('capacity'))
            };
            
            try {
                const response = await fetch(`/api/classes/${classId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('edit-class-modal');
                    loadClasses();
                    loadSchedule();
                } else {
                    const error = await response.json();
                    alert(error.error);
                }
            } catch (error) {
                console.error('Error updating class:', error);
            }
        }

        // Delete class
        async function deleteClass(classId) {
            if (!confirm('Are you sure you want to delete this class?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/classes/${classId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    loadClasses();
                    loadSchedule();
                } else {
                    const error = await response.json();
                    alert(error.error);
                }
            } catch (error) {
                console.error('Error deleting class:', error);
            }
        }

        // Modal functions
        function showCreateClassModal() {
            document.getElementById('create-class-modal').style.display = 'block';
        }

        function showEditClassModal(classId) {
            // Load class details and populate form
            fetch(`/api/trainer/classes/${classId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(cls => {
                document.getElementById('edit-class-id').value = cls.id;
                document.getElementById('edit-class-name').value = cls.class_name;
                document.getElementById('edit-schedule-time').value = cls.schedule_time;
                document.getElementById('edit-capacity').value = cls.capacity;
                document.getElementById('edit-class-modal').style.display = 'block';
            })
            .catch(error => console.error('Error loading class details:', error));
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadClasses();
            loadSchedule();
        });
    </script>
</body>
</html> 